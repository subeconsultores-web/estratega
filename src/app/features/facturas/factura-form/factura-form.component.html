<div class="space-y-6 pt-2 pb-16 animate-fade-in max-w-5xl mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-txt-primary">{{ isEditMode ? 'Editar' : 'Emitir' }} Factura</h1>
            <p class="text-sm text-txt-secondary mt-1">Registra cobros y formaliza transacciones económicas</p>
        </div>
        <button type="button" (click)="goBack()"
            class="px-4 py-2 border border-border rounded-lg text-txt-secondary hover:bg-surface-hover hover:text-txt-primary transition-colors flex items-center font-medium shadow-sm">
            <lucide-icon name="arrow-left" class="w-4 h-4 mr-2"></lucide-icon>
            Volver
        </button>
    </div>

    <!-- Spinner General -->
    <div *ngIf="isLoading" class="flex justify-center py-12">
        <lucide-icon name="loader-2" class="w-8 h-8 animate-spin text-primary"></lucide-icon>
    </div>

    <form *ngIf="!isLoading" [formGroup]="facturaForm" (ngSubmit)="onSubmit()" class="flex flex-col lg:flex-row gap-6">

        <!-- Info Principal (Left) -->
        <div class="flex-1 space-y-6">
            <div class="bg-surface rounded-xl shadow-sm border border-border p-6 space-y-6">

                <!-- Header Invoice Info -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-txt-primary">Cliente *</label>
                        <select formControlName="clienteId"
                            class="w-full px-3 py-2 border border-border rounded-lg bg-body text-txt-primary focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all">
                            <option value="" disabled selected>Selecciona un cliente</option>
                            <option *ngFor="let c of clientes" [value]="c.id">{{ c.razonSocial || c.nombreFantasia }}
                            </option>
                        </select>
                    </div>

                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-txt-primary">Moneda</label>
                        <select formControlName="moneda"
                            class="w-full px-3 py-2 border border-border rounded-lg bg-body text-txt-primary focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all">
                            <option value="CLP">CLP (Peso Chileno)</option>
                            <option value="USD">USD (Dólar)</option>
                            <option value="UF">UF</option>
                        </select>
                    </div>

                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-txt-primary">Fecha Emisión *</label>
                        <input type="date" formControlName="fechaEmision"
                            class="w-full px-3 py-2 border border-border rounded-lg bg-body text-txt-primary focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all text-sm">
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-txt-primary">Fecha Vencimiento *</label>
                        <input type="date" formControlName="fechaVencimiento"
                            class="w-full px-3 py-2 border border-border rounded-lg bg-body text-txt-primary focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all text-sm">
                    </div>
                </div>

                <!-- Detalle Económico Transaccional -->
                <div class="pt-4 mt-6 border-t border-border">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-semibold text-txt-primary">Detalle de Cobro</h3>
                        <button type="button" (click)="addItem()"
                            class="text-primary hover:text-primary-hover text-sm font-medium flex items-center transition-colors">
                            <lucide-icon name="plus" class="w-4 h-4 mr-1"></lucide-icon> Añadir Ítem
                        </button>
                    </div>

                    <div formArrayName="items" class="space-y-3">
                        <div *ngFor="let itemForm of itemsArray.controls; let i = index" [formGroupName]="i"
                            class="bg-body border border-border/80 rounded-lg p-3 grid grid-cols-12 gap-3 items-center group relative">

                            <!-- Descripcion -->
                            <div class="col-span-12 md:col-span-5">
                                <input type="text" formControlName="descripcion"
                                    placeholder="Descripción del producto o servicio"
                                    class="w-full px-2 py-1.5 text-sm bg-transparent border-b border-border/50 focus:border-primary outline-none transition-colors text-txt-primary">
                            </div>

                            <!-- Cantidad -->
                            <div class="col-span-4 md:col-span-2">
                                <input type="number" formControlName="cantidad" placeholder="Cant." min="1"
                                    class="w-full px-2 py-1.5 text-sm bg-transparent border-b border-border/50 focus:border-primary outline-none transition-colors text-txt-primary text-center">
                            </div>

                            <!-- P.U. -->
                            <div class="col-span-6 md:col-span-3 hover:bg-surface transition-colors rounded">
                                <div class="relative flex items-center">
                                    <span
                                        class="absolute left-2 text-txt-muted text-sm border-r border-border pr-1">$</span>
                                    <input type="number" formControlName="precioUnitario" placeholder="0" min="0"
                                        step="any"
                                        class="w-full pl-6 px-2 py-1.5 text-sm bg-transparent border-b border-border/50 focus:border-primary outline-none transition-colors text-txt-primary">
                                </div>
                            </div>

                            <!-- Eliminador -->
                            <button *ngIf="itemsArray.length > 1" type="button" (click)="removeItem(i)"
                                class="col-span-2 md:col-span-2 flex justify-center text-red-400 hover:text-red-500 hover:bg-red-500/10 p-1.5 rounded transition-colors opacity-0 group-hover:opacity-100">
                                <lucide-icon name="trash" class="w-4 h-4"></lucide-icon>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar Calculation -->
        <div class="w-full lg:w-80 space-y-6">
            <div class="bg-surface rounded-xl shadow-sm border border-border p-5 sticky top-6">
                <h3 class="text-sm font-semibold text-txt-primary mb-4 border-b border-border pb-3">Resumen de Totales
                </h3>

                <div class="space-y-4 pt-1 mb-6">
                    <div class="group">
                        <label
                            class="block text-xs font-medium text-txt-secondary mb-1 group-hover:text-primary transition-colors">Descuento
                            Global (%)</label>
                        <input type="number" formControlName="porcentajeDescuento" placeholder="0" min="0" max="100"
                            class="w-full px-3 py-1.5 border border-border rounded-lg bg-body text-txt-primary focus:ring-2 focus:ring-primary/20 transition-all text-sm">
                    </div>

                    <div class="group">
                        <label
                            class="block text-xs font-medium text-txt-secondary mb-1 group-hover:text-primary transition-colors">Impuesto
                            / VAT (%)</label>
                        <input type="number" formControlName="porcentajeImpuesto" placeholder="19" min="0" max="100"
                            class="w-full px-3 py-1.5 border border-border rounded-lg bg-body text-txt-primary focus:ring-2 focus:ring-primary/20 transition-all text-sm">
                    </div>
                </div>

                <!-- Math Auto-Recalcs View -->
                <div class="bg-body border border-border rounded-lg px-4 py-3 space-y-2 mb-6">
                    <div class="flex justify-between text-sm text-txt-secondary">
                        <span>Subtotal Base</span>
                        <span>$ {{ calcularTotales().subtotalBase | number }}</span>
                    </div>
                    <div class="flex justify-between text-sm text-red-500" *ngIf="calcularTotales().montoDescuento > 0">
                        <span>Descuento</span>
                        <span>- $ {{ calcularTotales().montoDescuento | number }}</span>
                    </div>
                    <div class="flex justify-between text-sm text-txt-secondary"
                        *ngIf="calcularTotales().montoImpuesto > 0">
                        <span>ReCargo Legal</span>
                        <span>+ $ {{ calcularTotales().montoImpuesto | number }}</span>
                    </div>
                    <div class="pt-2 mt-2 border-t border-border flex justify-between font-bold text-lg text-primary">
                        <span>Total Final</span>
                        <span>$ {{ calcularTotales().totalFinal | number }}</span>
                    </div>
                </div>

                <div class="space-y-3">
                    <button type="submit" [disabled]="facturaForm.invalid || isSaving"
                        class="w-full flex justify-center items-center px-4 py-2.5 bg-primary text-white rounded-lg hover:bg-primary-hover disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium shadow-sm shadow-primary/20">
                        <lucide-icon *ngIf="isSaving" name="loader-2" class="w-4 h-4 mr-2 animate-spin"></lucide-icon>
                        <lucide-icon *ngIf="!isSaving" name="save" class="w-4 h-4 mr-2"></lucide-icon>
                        {{ isEditMode ? 'Guardar Cambios' : 'Emitir Factura' }}
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>