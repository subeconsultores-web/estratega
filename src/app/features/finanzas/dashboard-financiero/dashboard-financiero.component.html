<div class="max-w-6xl mx-auto pb-12">
    <!-- Header -->
    <div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
            <h2 class="text-3xl font-bold text-gray-900 tracking-tight">Dashboard Financiero</h2>
            <p class="text-gray-500 mt-2 text-sm max-w-2xl">
                Monitorea tus ingresos, métricas recurrentes y la salud de cobranza en tiempo real.
            </p>
        </div>
        <div class="flex gap-3">
            <a routerLink="/finanzas/transacciones"
                class="btn btn-primary inline-flex items-center px-4 py-2 bg-primary text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors shadow-sm">
                <lucide-icon name="list" class="w-4 h-4 mr-2"></lucide-icon> Ver Transacciones
            </a>
            <button
                class="inline-flex items-center px-4 py-2 bg-white border border-gray-300 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-50 transition-colors shadow-sm cursor-not-allowed opacity-50">
                <lucide-icon name="credit-card" class="w-4 h-4 mr-2"></lucide-icon> Conectar Stripe
            </button>
        </div>
    </div>

    <!-- loading Skeleton -->
    <div *ngIf="isLoading">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div *ngFor="let _ of [1,2,3,4]"
                class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 h-32 animate-pulse"></div>
        </div>
    </div>

    <!-- KPI Cards -->
    <div *ngIf="!isLoading && metricas" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">

        <!-- MRR -->
        <div
            class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 flex flex-col justify-between hover:shadow-md transition-shadow">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-sm font-medium text-gray-500 mb-1">Monthly Recurring Revenue (MRR)</p>
                    <h3 class="text-2xl font-bold text-gray-900">${{ metricas.mrr | number:'1.0-0' }}</h3>
                </div>
                <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-primary">
                    <lucide-icon name="trending-up" class="w-5 h-5"></lucide-icon>
                </div>
            </div>
            <div class="mt-4 flex items-center text-sm">
                <span class="text-green-600 font-medium flex items-center">
                    <lucide-icon name="arrow-up-right" class="w-3 h-3 mr-1"></lucide-icon>
                    {{ metricas.crecimientoMRR }}%
                </span>
                <span class="text-gray-400 ml-2">vs mes anterior</span>
            </div>
        </div>

        <!-- Ingresos Actuales -->
        <div
            class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 flex flex-col justify-between hover:shadow-md transition-shadow">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-sm font-medium text-gray-500 mb-1">Ingresos (30 Días)</p>
                    <h3 class="text-2xl font-bold text-gray-900">${{ metricas.ingresosMesActual | number:'1.0-0' }}</h3>
                </div>
                <div class="w-10 h-10 rounded-full bg-green-50 flex items-center justify-center text-green-600">
                    <lucide-icon name="arrow-down-to-line" class="w-5 h-5"></lucide-icon>
                </div>
            </div>
            <div class="mt-4 flex items-center text-sm">
                <span class="text-gray-500">Recaudación efectiva mensual</span>
            </div>
        </div>

        <!-- Egresos Actuales -->
        <div
            class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 flex flex-col justify-between hover:shadow-md transition-shadow">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-sm font-medium text-gray-500 mb-1">Egresos (30 Días)</p>
                    <h3 class="text-2xl font-bold text-gray-900">${{ metricas.egresosMesActual | number:'1.0-0' }}</h3>
                </div>
                <div class="w-10 h-10 rounded-full bg-red-50 flex items-center justify-center text-red-600">
                    <lucide-icon name="arrow-up-from-line" class="w-5 h-5"></lucide-icon>
                </div>
            </div>
            <div class="mt-4 flex items-center text-sm">
                <span class="text-gray-500">Gastos y Salidas operativas</span>
            </div>
        </div>

        <!-- Por Cobrar -->
        <div
            class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 flex flex-col justify-between hover:shadow-md transition-shadow">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-sm font-medium text-gray-500 mb-1">Cuentas por Cobrar</p>
                    <h3 class="text-2xl font-bold text-gray-900">${{ metricas.porCobrar | number:'1.0-0' }}</h3>
                </div>
                <div class="w-10 h-10 rounded-full bg-amber-50 flex items-center justify-center text-amber-600">
                    <lucide-icon name="clock" class="w-5 h-5"></lucide-icon>
                </div>
            </div>
            <div class="mt-4 flex items-center text-sm">
                <span class="text-amber-600 font-medium">Facturas pendientes</span>
            </div>
        </div>

    </div>

    <!-- Layout Gráficas -->
    <div *ngIf="!isLoading" class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Main Chart -->
        <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Ingresos vs Egresos</h3>
            <div
                class="h-64 flex items-center justify-center bg-gray-50 rounded-lg border border-dashed border-gray-200 p-2">
                <canvas *ngIf="metricas?.historial && metricas!.historial!.length > 0; else noMap" baseChart
                    [data]="lineChartData" [options]="lineChartOptions" [type]="lineChartType">
                </canvas>
                <ng-template #noMap>
                    <div class="text-center text-gray-400">
                        <lucide-icon name="bar-chart-3" class="w-12 h-12 mx-auto mb-2 opacity-50"></lucide-icon>
                        <p class="text-sm">Gráfica Comercial de Cashflow</p>
                        <p class="text-xs mt-1">Sin transacciones registradas para este periodo.</p>
                    </div>
                </ng-template>
            </div>
        </div>

        <!-- Cobranza Sidebar -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 overflow-y-auto"
            style="max-height: 22rem;">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Próximos Cobros</h3>
            <div class="space-y-4">
                <div *ngIf="(proximosCobros$ | async)?.length === 0" class="text-sm text-gray-500 text-center py-4">
                    No hay cobros pendientes.
                </div>
                <div *ngFor="let factura of proximosCobros$ | async" [routerLink]="['/facturas', factura.id, 'view']"
                    class="flex items-center justify-between p-3 rounded-lg bg-gray-50 border border-gray-100 hover:bg-gray-100 transition-colors cursor-pointer">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-full bg-blue-100 text-primary flex items-center justify-center text-xs font-bold">
                            {{ factura.codigoFormateado?.substring(4,7) || 'FAC' }}</div>
                        <div>
                            <p class="text-sm font-medium text-gray-900">{{ factura.codigoFormateado }}</p>
                            <p class="text-xs text-gray-500">Vence: {{ factura.fechaVencimiento | date:'mediumDate' }}
                            </p>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="text-sm font-bold text-gray-900">{{ (factura.montoPendiente !== undefined ?
                            factura.montoPendiente : factura.total) | currency:factura.moneda:'symbol':'1.0-0' }}</span>
                        <div class="mt-1">
                            <span class="text-[10px] font-semibold uppercase rounded-full px-2 py-0.5 mt-1 inline-block"
                                [ngClass]="{
                                    'bg-yellow-100 text-yellow-800': factura.estado === 'pagada_parcial',
                                    'bg-red-100 text-red-800': factura.estado === 'vencida',
                                    'bg-blue-100 text-blue-800': factura.estado === 'emitida'
                                }">
                                {{ factura.estado }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>